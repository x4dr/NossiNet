{% extends "base/layout.html" %}
{% block head %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='mecha.css') }}?v={{ restart_id }}">
<script src="{{ url_for('static', filename='mechasheet.js') }}?v={{ restart_id }}"></script>
{% endblock %}

{% block body %}
<div class="comm-center-layout">
    <!-- Navigation Rail (Sidebar) -->
    <nav class="nav-rail">
        <div class="nav-item active" onclick="switchTab('movement', this)">
            <div class="nav-icon"></div>
            <div class="nav-label">MOVEMENT</div>
            <div class="nav-summary">
                Top Speed: <span class="highlight">{{ "%.1f"|format(mech.current_top_speed() if mech.current_top_speed
                    else 0) }}</span> km/h
            </div>
        </div>
        <div class="nav-item" onclick="switchTab('energy', this)">
            <div class="nav-icon"></div>
            <div class="nav-label">ENERGY</div>
            <div class="nav-summary">
                Output: <span class="highlight">{{ mech.energy_output() }}</span>
            </div>
        </div>
        <div class="nav-item" onclick="switchTab('heat', this)">
            <div class="nav-icon"></div>
            <div class="nav-label">HEAT</div>
            <div class="nav-summary">
                Flux: <span class="highlight">{{ mech.current_flux() }}</span>
            </div>
        </div>
        <div class="nav-item" onclick="switchTab('combat', this)">
            <div class="nav-icon"></div>
            <div class="nav-label">COMBAT</div>
            <div class="nav-summary">
                Systems: {{ mech.Offensive|length + mech.Defensive|length }}
            </div>
        </div>
    </nav>

    <!-- Main Display Area -->
    <main class="main-screen">
        <header class="screen-header">
            <h2 id="main-title">MOVEMENT ANALYSIS</h2>
            <div class="screen-status">ONLINE</div>
        </header>

        <!-- View: Movement -->
        <div id="view-movement" class="view-panel active">
            <section class="dashboard-section section-graph">
                <h3 class="stat-heading">Performance Graph</h3>
                {% set svg_w = 1000 %}
                {% set svg_h = 500 %}
                {% set margin = 40 %}
                {% set graph_w = svg_w - 2*margin %}
                {% set graph_h = svg_h - 2*margin %}
                {% set data = mech.speeds() %}
                {% set ns = namespace(max_time=1, max_speed=1) %}

                {% for _, sys in data.items() %}
                {% for t, v in sys.speeds.items() %}
                {% set ti = t|int %}{% if ti > ns.max_time %}{% set ns.max_time = ti %}{% endif %}
                {% if v > ns.max_speed %}{% set ns.max_speed = v %}{% endif %}
                {% endfor %}
                {% endfor %}

                <svg viewBox="0 0 {{ svg_w }} {{ svg_h }}" width="100%" height="{{ svg_h }}" id="speed-graph"
                    style="overflow: visible" data-max-time="{{ ns.max_time }}">

                    <!-- GRID -->
                    {% for i in range(0, 13) %}
                    <line x1="{{ margin + i/12 * graph_w }}" y1="{{ margin }}" x2="{{ margin + i/12 * graph_w }}"
                        y2="{{ svg_h - margin }}" class="grid"></line>

                    <line x1="{{ margin }}" y1="{{ margin + i/10 * graph_h }}" x2="{{ svg_w - margin }}"
                        y2="{{ margin + i/10 * graph_h }}" class="grid"></line>
                    {% endfor %}
                    {% set colors = ['#0055aa', '#00aa55', '#5500aa', '#55aa00', '#aa0055', '#aa5500'] %}
                    {% for name, sys in data.items() %}
                    <g class="curve-group" data-name="{{ name }}" data-speeds='{{ sys.speeds | tojson }}'
                        style="--curve-color: {{ colors[loop.index0 % colors|length] }}">

                        {% set last = namespace(x=0, y=0) %}
                        {% set points = [] %}
                        {% for t, v in sys.speeds.items() %}
                        {% set last.x = margin + (t|int / ns.max_time) * graph_w %}
                        {% set last.y = svg_h - margin - (v / ns.max_speed) * graph_h %}
                        {% set _ = points.append((last.x, last.y)) %}
                        {% endfor %}

                        {% if last.x < margin + graph_w %} {% set _=points.append((margin + graph_w, last.y)) %} {%
                            endif %} <!-- {{ points }} {{name}}-->

                            {% set points_str = points | map("join", ",") | join(" ") %}
                            <polyline class="curve-hit" fill="none" stroke="transparent" stroke-width="14"
                                pathLength="1" points="{{ points_str }}">
                            </polyline>
                            <polyline class="curve animated" fill="none" stroke-width="2" pathLength="1"
                                points="{{ points_str }}">
                            </polyline>

                            <text x="{{ margin + 10 }}" y="{{ margin + 20 + loop.index * 20 }}"
                                class="curve-label legend-item">
                                {{ name }} ({{ "%.1f"|format(sys.topspeed) }} km/h)
                            </text>

                    </g>
                    {% endfor %}
                    <line id="cursor-line" y1="{{ margin }}" y2="{{ svg_h - margin }}" x1="{{ margin }}"
                        x2="{{ margin }}" class="cursor-line"></line>

                    <g id="tooltip" visibility="hidden" class="tooltip">
                        <rect x="0" y="0" width="1" height="1" rx="4" ry="4"></rect>
                        <text x="0" y="0">
                            <tspan id="tooltip-title" x="0" dy="1.2em"></tspan>
                            <tspan id="tooltip-value" x="0" dy="1.2em"></tspan>
                        </text>
                    </g>
                    <!-- AXES -->
                    <line x1="{{ margin }}" y1="{{ svg_h - margin }}" x2="{{ svg_w - margin }}"
                        y2="{{ svg_h - margin }}" class="axis"></line>

                    <line x1="{{ margin }}" y1="{{ margin }}" x2="{{ margin }}" y2="{{ svg_h - margin }}" class="axis">
                    </line>


                </svg>
            </section>

            <section class="dashboard-section section-movement-list">
                <h3 class="stat-heading">Movement Systems</h3>
                <div class="system-row">
                    {% for energy in mech.Movement.values() %}
                    <div hx-get="{{ url_for('sheets.mecha_sys', m=identifier, s='movement', n=energy.name) }}"
                        hx-swap="outerHTML" hx-trigger="load"></div>
                    {% endfor %}
                </div>
            </section>
        </div>

        <!-- View: Energy -->
        <div id="view-energy" class="view-panel">
            <section class="dashboard-section section-energy-meter">
                <h3 class="stat-heading">Primary Reactor Output</h3>
                <div style="margin-top: 20px;">
                    <div hx-get="{{ url_for('sheets.energy_meter', m=identifier) }}" hx-swap="innerHTML"
                        hx-trigger="load, htmx:afterSettle from:.system-row">
                    </div>
                </div>
            </section>
            <section class="dashboard-section">
                <h3 class="stat-heading">Generators & Batteries</h3>
                <div class="system-row">
                    {% for energy in mech.Energy.values() %}
                    <div hx-get="{{ url_for('sheets.mecha_sys', m=identifier, s='energy', n=energy.name) }}"
                        hx-swap="outerHTML" hx-trigger="load"></div>
                    {% endfor %}
                </div>
            </section>
        </div>

        <!-- View: Heat -->
        <div id="view-heat" class="view-panel">
            <section class="dashboard-section">
                <h3 class="stat-heading">Core Temperature</h3>
                <div hx-get="{{ url_for('sheets.mech_heat_ui', m=identifier) }}" hx-swap="innerHTML"
                    hx-trigger="load, htmx:afterSettle from:.system-row">
                </div>
            </section>
            <section class="dashboard-section">
                <h3 class="stat-heading">Sinks & Vents</h3>
                <div class="system-row">
                    {% for heat in mech.Heat.values() %}
                    <div hx-get="{{ url_for('sheets.mecha_sys', m=identifier, s='heat', n=heat.name) }}"
                        hx-swap="outerHTML" hx-trigger="load"></div>
                    {% endfor %}
                </div>
            </section>
        </div>

        <!-- View: Combat -->
        <div id="view-combat" class="view-panel">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <section class="dashboard-section">
                    <h3 class="stat-heading">Offensive</h3>
                    <div class="system-row">
                        {% for system in mech.Offensive.values() %}
                        <div hx-get="{{ url_for('sheets.mecha_sys', m=identifier, s='offensive', n=system.name) }}"
                            hx-swap="outerHTML" hx-trigger="load"></div>
                        {% endfor %}
                    </div>
                </section>
                <section class="dashboard-section">
                    <h3 class="stat-heading">Defensive & Support</h3>
                    <div class="system-row">
                        {% for system in mech.Defensive.values() %}
                        <div hx-get="{{ url_for('sheets.mecha_sys', m=identifier, s='defensive', n=system.name) }}"
                            hx-swap="outerHTML" hx-trigger="load"></div>
                        {% endfor %}
                        {% for system in mech.Support.values() %}
                        <div hx-get="{{ url_for('sheets.mecha_sys', m=identifier, s='support', n=system.name) }}"
                            hx-swap="outerHTML" hx-trigger="load"></div>
                        {% endfor %}
                    </div>
                    <div class="dashboard-section" style="margin-top: 20px">
                        <h3 class="stat-heading">Seals</h3>
                        <div
                            style="display: grid; grid-template-columns: 1fr auto; gap: 5px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px;">
                            <div class="stat-label">Name</div>
                            <div class="stat-label">Lvl</div>
                            {% for seal in mech.Seal.values() %}
                            <div class="system-name">{{ seal.name }}</div>
                            <div class="stat-value">{{ seal.level }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>
</div>

<script>
    function switchTab(tabName, element) {
        // 1. Update Navigation Rail
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // 2. Switch Main Display Content
        document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');

        // 3. Update Header Title
        const titles = {
            'movement': 'MOVEMENT ANALYSIS',
            'energy': 'POWER GRID STATUS',
            'heat': 'THERMAL REGULATION',
            'combat': 'COMBAT SYSTEMS'
        };
        document.getElementById('main-title').textContent = titles[tabName];

        // 4. Trigger Resize (for graphs/animations to re-flow if needed)
        window.dispatchEvent(new Event('resize'));
    }
</script>
{% endblock %}
