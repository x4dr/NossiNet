{%- extends "layout.html" -%}
{%- macro dots(val,max=5) -%}
    {%- if val is not defined -%}
        {%- set val = 0 -%}
    {%- endif -%}
    {%- for i in range(val) -%}
        {%- if loop.index0%5 == 0 and loop.index0 > 0 %} {% endif -%}
        ●
    {%- endfor -%}
    {%- for i in range(max-val) -%}
        ○
    {%- endfor -%}
{%- endmacro -%}
{% macro tablematrix(sectiondata) %}
    <table class="dividedtable">
        {% for line in sectiondata -%}
            {% if loop.index0!=1 %} {# the - - - line in md #}
                {% if loop.first %}
                    <thead>
                {% endif %}
            <tr>
                {% set outer_loop = loop %}
                {% for subline in line -%}
                    <td class="le{% if outer_loop.first %}e{% endif %}et">{{ subline }}</td>
                {% endfor -%}
            </tr>
            {% if loop.first %}
                </thead>
                <tbody>
                {% elif loop.last %}
                </tbody>
            {% endif %}
            {% endif %}
        {%- endfor %}
    </table>
{% endmacro %}
{% macro sectionformat(cat) %}
    {%- for k,v in cat.items() -%}
        {%- if v is mapping -%}
            <tr>
                <td colspan="2" style="text-align: center;" class="leet">{{ k }}</td>
            </tr>
            {%- for vk,vv in v.items() -%}
                <tr>
                    <td style="text-align: left; word-wrap: break-word">{{ vk|remove_leading_underscore }} </td>
                    <td class="tooltip">{%- if vv|remove_leading_underscore|int(-1) != -1
                            and (userconf["fensheet_dot_max"] |int) >= vv|remove_leading_underscore|int -%}{{
                            dots(vv|remove_leading_underscore|int, userconf["fensheet_dot_max"]|int(5))
                            if userconf["fensheet_dots"]|int(0) else vv }}
                    {%- else -%}{{ vv }}{%- endif -%}{% if
                            k in ["Fähigkeiten", "Aspekte","Quellen"] %} <span class="tooltiptext">&nbsp;+&nbsp;{{ character.seekxp(vk) }}&nbsp;FP</span>{%- endif -%}</td>
                </tr>
            {%- endfor -%}
        {% else %}
            Debug: {{ v }} has no items
        {%- endif -%}
    {%- endfor %}
{% endmacro %}
{%- macro catformat(cat, name, cost) -%}
    <table style = "width: 100%">
        <tr>
            <td colspan="2" style="text-align: center;" class="leeet tooltip">{{ name }} {% if name!='Magie' %}<a href="{{url_for('fen_calc',
            inputstring=cost) }} ">{{ cost }}</a><span class="tooltiptext"><br/>&nbsp;Options:<br/>{% for l in
                    character.cost_calc(cost)
                    %}&nbsp;&nbsp;{% for b in l %}{{ b }}{% if not loop.last %}, {% endif %}{% endfor %}&nbsp;&nbsp;<br/> {% endfor %}<br/> {% else %}<a href="{{
                    url_for('fen_calc', inputstring=cost, costs='30, 80, 140, 210, 300',penalty='',width=1)
                    }}">{{ cost }}</a><span class="tooltiptext">{% for l in
                    character.cost_calc(cost,'30, 80, 140, 210, 300','', width=1)
                    %}{{ l }}<br/> {% endfor %}{% endif %}</span></td>

        </tr>
        {%- if cat is mapping  -%}
            {{ sectionformat(cat) }}
        {% else %}
            Error: {{ cat }} is no dict
        {% endif %}
    </table>
{%- endmacro -%}
{%- block title -%}
    {%- if character.Name -%}
        <title>{{ character.Name }}</title>
    {%- else -%}
        <title>Charactersheet</title>
    {%- endif -%}
{%- endblock -%}

{%- block body -%}
    <table style ="width:100%; " class="leet dividedtable">
        <tr>
            <td colspan="6" style="text-align: center; font-size: 1.5em" class="leeet">
                {%- if character.Name -%}
                    Charactersheet&nbspfor&nbsp{{ character.Name }}
                {%- else -%}
                    Charactersheet&nbspfor&nbspUnnamed&nbspCharacter
                {%- endif -%}</td>
        </tr> <tr>
        {%- for key,val in character.Character.items() -%}
            <td class="dividedtable" style="text-align: center; width: 15%; border-bottom-color: #0d9318; border-left-color: #0d9318;  ">{{ key }}</td>
            <td class="dividedtable" style="text-align: center; width: 15%; border-bottom-color: #0d9318; border-right-color: #0d9318;  white-space: pre-wrap">
                {%- if val is string -%}
                    {{ val }}
                {%- else -%}
                    {{ val|join("\n") }}
                {%- endif -%}
            </td>
            {%- if loop.index%3==0 and not loop.last -%}
                </tr><tr>
            {%- endif -%}
        {%- if loop.last -%}
            </tr>
        {%- endif -%}
        {%- endfor -%}
    </table>
    <div style="text-align: center ">
        {%- for category,data in character.Categories.items() -%}
            <div style="display: inline-block; width: 30%; vertical-align: top;">
                {{- catformat(data,category, character.points(category))-}}
            </div>
        {% endfor -%}
    </div>
    {%- for key,data in character.Meta.items() -%}
        <h2 class="hideable">o{{ key }}</h2>
        <div>
            {%- for section,sectiondata in data.items() -%}
                {%- if section|trim|length and section != "_table" -%}
                    <h3 class="hideable">*{{ section|markdown }}</h3>
                {%- endif -%}
                <div>
                    {% if sectiondata is mapping %}
                        {% for k, v in sectiondata.items() %}
                            {%- if k =="_table" -%}
                                {{ tablematrix(v) }}
                            {%- else -%}
                                <h4 class="hideable">*{{ k|markdown }}</h4>
                                <div>{% for line in v["_lines"]  %}
                                    {{ line|markdown }}
                                {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor -%}
                    {%- else %}
                        {%- if section =="_table" -%}
                            {{ tablematrix(sectiondata) }}
                        {%- else -%}
                            {%- for line in sectiondata|markdown -%}
                                {{ line| markdown }}
                            {%- endfor %}
                        {% endif %}
                    {% endif %}

                </div>
            {%- endfor -%}
        </div>
    {%- endfor -%}
    <div><button id="TopButton" title="Upwards">Top</button></div>

{%- endblock -%}
